# 数据库初始化说明

## 概述

axi-star-cloud 后端现在使用安全的动态数据库初始化系统，确保所有必需的表都能正确创建和验证，同时保护现有数据不被覆盖。

## 功能特性

### 1. 安全的动态表检查
- 自动扫描数据库中现有的表
- 只在缺失时才创建表（不会覆盖现有表）
- 验证所有必需的表都存在
- 保护现有数据不被覆盖

### 2. 必需的表
系统会自动检查并创建以下表：
- `user` - 用户表
- `files` - 文件表
- `folders` - 文件夹表
- `documents` - 文档表
- `update_logs` - 更新日志表
- `url_files` - URL文件表

### 3. 安全的自动迁移
- 执行数据库结构迁移
- 添加新字段（只在不存在时）
- 删除不需要的字段（安全删除）
- 更新索引（只在必要时）
- 保护现有数据完整性

## 安全机制

### 1. 表创建保护
- 使用 `CREATE TABLE IF NOT EXISTS` 语句
- 只在表不存在时才创建
- 不会删除或覆盖现有表

### 2. 数据保护
- 只在user表为空时才插入初始数据
- 不会重复插入管理员用户
- 保护现有用户数据

### 3. 迁移保护
- 迁移操作都是幂等的
- 字段添加使用 `IF NOT EXISTS`
- 索引创建使用 `IF NOT EXISTS`

## 使用方法

### 正常启动
```bash
go run main.go
```

### 重置更新日志表
```bash
go run main.go --reset-db
```

### 完全重置数据库
```bash
go run main.go --reset-all
```

## API 端点

### 健康检查
- `GET /ready` - 就绪检查（包含表验证）
- `GET /live` - 存活检查
- `GET /metrics` - 系统指标
- `GET /db-status` - 数据库状态检查

### 数据库状态检查响应示例
```json
{
  "status": "healthy",
  "connection": "healthy",
  "tables": {
    "existing": ["user", "files", "folders", "documents", "update_logs", "url_files"],
    "missing": [],
    "details": {
      "user": {
        "exists": true,
        "row_count": 1
      },
      "files": {
        "exists": true,
        "row_count": 0
      }
    }
  },
  "timestamp": "2024-01-01T12:00:00Z"
}
```

## 初始化流程

1. **连接检查** - 验证数据库连接
2. **表扫描** - 获取现有表列表
3. **缺失检查** - 检查哪些必需的表缺失
4. **安全创建** - 只创建缺失的表（不覆盖现有表）
5. **迁移执行** - 执行数据库迁移（只在必要时）
6. **初始数据** - 只在user表为空时插入初始数据
7. **验证检查** - 验证所有表都存在

## 错误处理

### 常见错误
- 数据库连接失败
- 表创建失败
- 迁移执行失败
- 必需表缺失

### 自愈机制
- 自动重试表创建
- 迁移失败时的回滚
- 连接失败时的重连

## 配置

数据库配置在 `config/config-prod.yaml` 中：

```yaml
database:
  host: '127.0.0.1'
  port: '3306'
  user: 'root'
  password: '123456'
  name: 'docs'
```

## 日志

初始化过程会输出详细的日志信息：

```
开始初始化数据库...
✓ 数据库连接正常
发现现有表: map[files:true folders:true user:true]
✓ 所有必需的表都已存在
✓ 数据库初始化完成
```

## 安全测试

系统经过以下安全测试：
- 多次启动不会重复创建表
- 现有数据不会被覆盖
- 管理员用户不会被重复插入
- 表结构不会被意外修改

## 故障排除

### 1. 表不存在错误
如果遇到 "表不存在" 错误，可以：
- 使用 `--reset-all` 完全重置数据库
- 检查数据库连接配置
- 查看初始化日志

### 2. 权限错误
确保数据库用户有以下权限：
- CREATE
- DROP
- ALTER
- INDEX
- SELECT
- INSERT
- UPDATE
- DELETE

### 3. 连接错误
检查：
- 数据库服务是否运行
- 连接配置是否正确
- 网络连接是否正常

### 4. 数据保护
- 系统不会自动删除现有数据
- 只有在明确使用重置命令时才会清空数据
- 建议定期备份重要数据
